%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Copyright 2021 Benjamin Nussbaum
%
% Based on the `metropolis' beamer theme,
% Copyright 2015 Matthias Vogelgesang and the LaTeX community. A full list of
% contributors can be found at
%
%     https://github.com/matze/mtheme/graphs/contributors
%
% and the original template was based on the HSRM theme by Benjamin Weiss.
%
% This work is licensed under a Creative Commons Attribution-ShareAlike 4.0
% International License (https://creativecommons.org/licenses/by-sa/4.0/).

\newif\if@nav
\DeclareOptionBeamer{nav}{\@navtrue}
\ProcessOptionsBeamer

\mode<presentation>

% Make the progress bar easier to see, but not obtrusive
\setlength{\metropolis@progressinheadfoot@linewidth}{2.0pt} % Default 0.4pt
\setbeamertemplate{progress bar in head/foot}{
  \nointerlineskip
  % \setlength{\metropolis@progressinheadfoot}{%
  %   \paperwidth * \ratio{\insertframenumber pt}{\inserttotalframenumber pt}%
  % }%
  % Since \totalframenumber is capped at the \appendix call, cap the progress bar length
  % at the \paperwidth to prevent unwanted artefacts with \pgfpagesuselayout{n on 1} handouts.
  \pgfmathsetlength{\metropolis@progressinheadfoot}{%
    % Subtract 1 (ignoring the title frame) to improve the visual progression
    % of the progress bar in shorter presentations.
    min(\paperwidth * (\insertframenumber-1)/(\inserttotalframenumber-1), \paperwidth))%
  }%
  \begin{beamercolorbox}[wd=\paperwidth]{progress bar in head/foot}
    \tikzexternaldisable%
    \begin{tikzpicture}
      \fill[bg] (0,0) rectangle (\paperwidth, \metropolis@progressinheadfoot@linewidth);
      \fill[fg] (0,0) rectangle (\metropolis@progressinheadfoot, \metropolis@progressinheadfoot@linewidth);
    \end{tikzpicture}%
    \tikzexternalenable%
  \end{beamercolorbox}
}

% ------------------------------------------------------------------------------
% Don't include \appendix frames in the \totalframenumber
% (Adapted from https://www.ctan.org/pkg/appendixnumberbeamer)

\def\mainframenumber{-1}
% When \appendix is called, record the total number of main content frames
\pretocmd{\appendix}{\xdef\mainframenumber{\theframenumber}}{}{}

% At the end of document, set the \totalframenumber
% to the number of main content frames recorded at the \appendix call.
\AtEndDocument%
{
    \ifnum\mainframenumber>0
    \immediate\write\@auxout
    {
        \string\@writefile{nav}
        {
            \headcommand
            {
                \gdef\noexpand\inserttotalframenumber{\mainframenumber}
            }
        }
    }
    \fi
}

% ------------------------------------------------------------------------------
% If a filename is provided, add the image at the top right of each frame
\newcommand{\frametitlelogo}[1]
{
    \ifx#1\@empty\else
        \addtobeamertemplate{frametitle}{}
        {
            \begin{tikzpicture}[remember picture,overlay]
            \node[below=1.45\metropolis@frametitle@padding, left]
                at (current page.north east)
            {
                \raggedleft
                \includegraphics[height=2.9\metropolis@frametitle@padding]{#1}
            };
            \end{tikzpicture}
        }
    \fi
}

% ------------------------------------------------------------------------------
% If the [nav] option is used, add a section navigation bar in the footline
\if@nav
    \setbeamertemplate{footline}
    {
        \begin{beamercolorbox}[sep=1.2ex]{section in head/foot}%
        \insertsectionnavigationhorizontal{\paperwidth}{}
        {
            \hspace{1em}
            \usebeamertemplate*{frame numbering}
            \hspace{2em}
        }
        \end{beamercolorbox}%
    }
    % Adjust vertical alignment of body between frametitle and nav bar
    \addtobeamertemplate{frametitle}{}{\vspace*{-\footheight}}
\fi

\mode
<all>
